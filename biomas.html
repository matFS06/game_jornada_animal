<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Jogo dos Biomas - Expedi√ß√£o Geogr√°fica</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: 'Comic Sans MS', sans-serif;
      background-color: #e0f7fa;
      text-align: center;
      background-image: url('biomas.png');
      background-size: cover;
      margin: 0;
      min-height: 100vh;
    }

    .container {
      background: white;
      max-width: 650px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 15px;
      border: 5px solid #00695c;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    input, button {
      padding: 10px;
      font-size: 18px;
      margin-top: 15px;
      border-radius: 5px;
      border: none;
    }

    button {
      background-color: #00796b;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover { background-color: #004d40; transform: scale(1.05); }

    #memory-game {
      margin: 20px auto;
      display: grid;
      grid-gap: 10px;
      justify-content: center;
    }

    .card {
      width: 100px;
      height: 100px;
      background-color: #b2dfdb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 10px;
      user-select: none;
      border: 2px solid #00695c;
      transition: background-color 0.3s, transform 0.5s;
    }

    /* Removido o rotateY(180deg) que causava o efeito de espelho */
    .card.flipped {
      background-color: #004d40;
      color: white;
      transform: scale(1.05);
    }

    #explanation {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff59d;
      border: 2px solid #fbc02d;
      border-radius: 10px;
      display: none;
    }

    #explanation img {
      max-width: 200px;
      margin-top: 10px;
      border-radius: 10px;
      border: 2px solid #00695c;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #chart-container { width: 100%; height: 300px; margin-top: 20px; }

    #score-card {
      background-color: #e0f2f1;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: 2px solid #004d40;
    }
  </style>
</head>
<body>

  <div id="start-screen" class="container">
    <h2>Bem-vindo ao M√≥dulo dos Biomas!</h2>
    <img src="logo_biomas.png" alt="Logo Biomas" style="max-width: 250px; margin-bottom: 20px; border-radius: 10%;">
    <br> 
    <input type="text" id="player-name" placeholder="Digite seu nome">
    <br>
    <button onclick="startGame()">Iniciar Jornada</button>
  </div>

  <div id="game-container" class="container" style="display:none;">
    <div id="score-card">
      <strong>Explorador:</strong> <span id="player-display"></span> |
      <strong>Pontos:</strong> <span id="score">0</span>
    </div>
    <h3 id="greeting"></h3>
    <div id="memory-game"></div>
    
    <div id="explanation"></div>
    
    <div id="congrats" style="display: none;">
      <h3>üå≥ Expedi√ß√£o Conclu√≠da com Sucesso!</h3>
      <div id="chart-container"><canvas id="biomaChart"></canvas></div>
      <button onclick="generatePDF()" style="background-color: #2e7d32;">üìÑ Baixar Boletim Geogr√°fico</button>
      <br>
      <button onclick="location.reload()" style="background-color: #555; color: white; padding: 10px; margin-top: 10px; border-radius: 5px; border: none; cursor: pointer;">üîÑ Reiniciar</button>
      <button onclick="goToNextModule()" style="background-color: #00796b;">‚û°Ô∏è Pr√≥ximo M√≥dulo</button>
    </div>
    
    <button id="next-phase" style="display:none;" onclick="nextPhase()">Pr√≥xima Fase ‚ûî</button>
  </div>

  <script>
    const allBiomas = [
      { name: "Amaz√¥nia", explanation: "Maior floresta tropical do mundo, essencial para o equil√≠brio clim√°tico.", image: "amazonia.jpg" },
      { name: "Caatinga", explanation: "Bioma semi√°rido exclusivo do Brasil, com plantas que armazenam √°gua.", image: "caatinga.jpg" },
      { name: "Pampas", explanation: "Campos do Sul, com vegeta√ß√£o rasteira e clima mais frio.", image: "pampas.jpg" },
      { name: "Cerrado", explanation: "A savana brasileira, com √°rvores de troncos retorcidos e solo √°cido.", image: "cerrado.jpg" },
      { name: "Pantanal", explanation: "Maior plan√≠cie inund√°vel do mundo e ref√∫gio de muitas esp√©cies.", image: "pantanal.jpg" },
      { name: "Mata Atl√¢ntica", explanation: "Floresta litor√¢nea rica em biodiversidade, hoje protegida em √°reas de preserva√ß√£o.", image: "mata_atlantica.jpg" }
    ];

    const phases = [
      { pairs: 2, points: 20, columns: 2 },
      { pairs: 4, points: 40, columns: 4 },
      { pairs: 6, points: 40, columns: 4 }
    ];

    let currentPhase = 0;
    let playerName = "";
    let score = 0;
    let firstCard = null, secondCard = null;
    let lockBoard = false;
    let matchedPairs = 0;
    
    let totalClicksPerPhase = [];
    let currentPhaseClicks = 0;
    let biomasEncontradosSet = new Set();

    function startGame() {
      playerName = document.getElementById("player-name").value.trim();
      if (!playerName) return alert("Por favor, digite seu nome!");
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-container").style.display = "block";
      document.getElementById("player-display").innerText = playerName;
      loadPhase();
    }

    function loadPhase() {
      matchedPairs = 0;
      currentPhaseClicks = 0;
      resetTurn();
      document.getElementById("explanation").style.display = "none";
      
      const phase = phases[currentPhase];
      const selected = allBiomas.slice(0, phase.pairs);
      const cards = [...selected, ...selected].sort(() => 0.5 - Math.random());
      
      const grid = document.getElementById("memory-game");
      grid.innerHTML = "";
      grid.style.gridTemplateColumns = `repeat(${phase.columns}, 100px)`;
      document.getElementById("greeting").innerText = `Fase ${currentPhase + 1}: Encontre os pares!`;

      cards.forEach((card, index) => {
        const el = document.createElement("div");
        el.classList.add("card");
        el.dataset.name = card.name;
        el.textContent = "?";
        el.onclick = () => flipCard(el, card);
        grid.appendChild(el);
      });
    }

    function flipCard(el, card) {
      if (lockBoard || el.classList.contains("flipped")) return;
      
      currentPhaseClicks++;
      el.classList.add("flipped");
      el.textContent = card.name;

      if (!firstCard) {
        firstCard = { el, card };
      } else {
        secondCard = { el, card };
        lockBoard = true;
        checkMatch();
      }
    }

    function checkMatch() {
      if (firstCard.card.name === secondCard.card.name) {
        matchedPairs++;
        score += 10;
        document.getElementById("score").innerText = score;
        
        showExplanation(secondCard.card);
        biomasEncontradosSet.add(secondCard.card.name);

        if (matchedPairs === phases[currentPhase].pairs) {
          totalClicksPerPhase.push(currentPhaseClicks);
          setTimeout(() => {
            if (currentPhase < phases.length - 1) {
              document.getElementById("next-phase").style.display = "inline-block";
            } else {
              showFinalScreen();
            }
          }, 1000);
        }
        resetTurn();
      } else {
        setTimeout(() => {
          firstCard.el.classList.remove("flipped");
          firstCard.el.textContent = "?";
          secondCard.el.classList.remove("flipped");
          secondCard.el.textContent = "?";
          resetTurn();
        }, 1000);
      }
    }

    function resetTurn() { [firstCard, secondCard, lockBoard] = [null, null, false]; }

    function showExplanation(card) {
      const container = document.getElementById("explanation");
      container.innerHTML = `
        <h4 style="color: #00695c; margin-bottom: 5px;">‚úÖ Descoberta: ${card.name}</h4>
        <p style="margin-bottom: 10px;">${card.explanation}</p>
        <img src="${card.image}" alt="Imagem de ${card.name}">
      `;
      container.style.display = "block";
    }

    function nextPhase() {
      currentPhase++;
      document.getElementById("next-phase").style.display = "none";
      loadPhase();
    }

    function showFinalScreen() {
      document.getElementById("memory-game").style.display = "none";
      document.getElementById("explanation").style.display = "none";
      document.getElementById("greeting").style.display = "none";
      document.getElementById("congrats").style.display = "block";

      const ctx = document.getElementById('biomaChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Fase 1', 'Fase 2', 'Fase 3'],
          datasets: [{
            label: 'N√∫mero de Cliques',
            data: totalClicksPerPhase,
            backgroundColor: '#80cbc4',
            borderColor: '#00695c',
            borderWidth: 2
          }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } } 
        }
      });
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFillColor(0, 105, 92);
      doc.rect(0, 0, 210, 20, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.text("BOLETIM DE EXPEDI√á√ÉO: BIOMAS BRASILEIROS", 15, 13);

      doc.setTextColor(0,0,0);
      doc.setFontSize(12);
      doc.text(`Explorador: ${playerName}`, 15, 30);
      doc.text(`Pontua√ß√£o Final: ${score} pontos`, 15, 38);

      const biomasArray = Array.from(biomasEncontradosSet);
      const tableRows = biomasArray.map(name => {
        const b = allBiomas.find(bio => bio.name === name);
        return [b.name, b.explanation, "Conclu√≠do"];
      });

      doc.autoTable({
        startY: 45,
        head: [['Bioma', 'Caracter√≠sticas Principais', 'Resultado']],
        body: tableRows,
        headStyles: { fillColor: [128, 203, 196], textColor: [0, 77, 64] },
        theme: 'striped'
      });

      doc.save(`expedicao_biomas_${playerName}.pdf`);
    }

    function goToNextModule() { window.location.href = "paises.html"; }
  </script>
</body>
</html>