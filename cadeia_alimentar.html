<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogo da Cadeia Alimentar</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Comic Sans MS', sans-serif;
      background-color: #d0f4ff;
      padding: 20px;
      text-align: center;
      background-image: url('cadeia_alimentar.png');
      background-size: cover;
      background-position: center;
      min-height: 100vh;
    }

    .container {
      max-width: 600px;
      margin: 30px auto;
      background-color: white;
      padding: 20px;
      border-radius: 15px;
      border: 5px solid #1177d1;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn {
      font-size: 18px;
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      border-radius: 5px;
    }

    .btn-selvagem {
      background-color: #1b4d3e !important;
    }

    .animal-slot {
      border: 2px dashed #1177d1;
      padding: 15px;
      margin: 10px;
      min-height: 50px;
      border-radius: 10px;
      background-color: #f0f8ff;
      cursor: pointer;
    }

    .animal {
      display: inline-block;
      padding: 8px 12px;
      margin: 5px;
      background-color: #ffc107;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .animal.selected {
      border: 4px solid #1177d1 !important;
      box-shadow: 0 0 15px rgba(17, 119, 209, 0.8);
      transform: scale(1.05);
    }

    #player-name {
      font-size: 18px;
      padding: 8px;
      width: 80%;
      max-width: 300px;
      margin-bottom: 20px;
    }

    #feedback {
      font-size: 20px;
      font-weight: bold;
      min-height: 30px;
      margin-top: 10px;
    }

    #chart-container {
      width: 100%;
      height: 300px;
      margin: 20px 0;
    }
  </style>
</head>
<body>

  <div id="start-screen" class="container">
    <h2>Bem-vindo ao M√≥dulo da Cadeia Alimentar!</h2>
    <img src="logo_cadeia.png" alt="Logo" style="max-width: 250px; margin-bottom: 20px; border-radius: 10%;"/>
    <br>
    <input type="text" id="player-name" placeholder="Digite seu nome">
    <br>
    <button class="btn" onclick="startGame()">Iniciar</button>
  </div>

  <div id="scoreboard-container" class="container" style="display:none;">
    <div class="scoreboard">
      <span id="player-display"></span> | <span id="score">Pontos: 0</span> | <span id="lives">Vidas: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
    </div>
  </div>

  <div id="game-container" class="container" style="display:none;">
    <h3 id="question-title">Selecione o animal e clique na posi√ß√£o:</h3>
    <div class="d-flex flex-column align-items-center">
      <div class="animal-slot" id="consumidor2" onclick="placeAnimal('consumidor2')">Consumidor Secund√°rio</div>
      <div class="animal-slot" id="consumidor1" onclick="placeAnimal('consumidor1')">Consumidor Prim√°rio</div>
      <div class="animal-slot" id="produtor" onclick="placeAnimal('produtor')">Produtor</div>
    </div>
    <div id="options" class="mt-4"></div>
    <button id="verify-btn" class="btn" onclick="checkAnswer()">Verificar</button>
    <div id="feedback"></div>
  </div>

  <div id="explanation-container" class="container" style="display: none;">
    <h4>Explica√ß√£o:</h4>
    <p id="explanation-text"></p>
    <img id="explanation-image" src="" alt="Explica√ß√£o Visual" style="max-width: 100%; border-radius: 10px; margin: 10px 0;" />
    <br><button class="btn" onclick="nextQuestion()">Continuar</button>
  </div>

  <div id="end-screen" class="container text-center" style="display: none;">
    <h2>üéâ Parab√©ns, <span id="final-player-name"></span>!</h2>
    <div id="chart-container"><canvas id="attemptsChart"></canvas></div>
    <button class="btn btn-selvagem" onclick="generatePDF()">Gerar Boletim Detalhado</button>
    <br><button class="btn btn-success" onclick="location.reload()">üîÑ Reiniciar</button>
    <button class="btn btn-primary" onclick="window.location.href='nutrientes.html'">‚û°Ô∏è Pr√≥ximo M√≥dulo</button>
  </div>

  <script>
    let currentIndex = 0;
    let score = 0;
    let lives = 5;
    let playerName = "";
    let selectedAnimalValue = null;
    let selectedElement = null;
    
    let attemptsPerQuestion = []; 
    let currentAttempts = 0;      
    let allResponsesLog = [];     

    const questions = [
      {
        animals: ["Capim", "Gafanhoto", "Sapo"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "O capim √© o produtor, o gafanhoto √© o consumidor prim√°rio e o sapo √© o consumidor secund√°rio.",
        image: "capim_gafanhoto_sapo.png"
      },
      {
        animals: ["Alga", "Peixe pequeno", "Gar√ßa"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "A alga produz energia, o peixe pequeno se alimenta dela e a gar√ßa se alimenta do peixe.",
        image: "alga_peixe_garca.png"
      },
      {
        animals: ["Milho", "Galinha", "Gavi√£o"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "O milho √© o produtor, a galinha √© o consumidor prim√°rio e o gavi√£o √© o consumidor secund√°rio.",
        image: "milho_galinha_gaviao.png"
      },
      {
        animals: ["Feijoeiro", "Lagarta", "P√°ssaro"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "O feijoeiro √© o produtor, a lagarta √© o consumidor prim√°rio e o p√°ssaro o consumidor secund√°rio.",
        image: "feijoeiro_lagarta_passaro.png"
      },
      {
        animals: ["Grama", "Vaca", "Humano"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "A grama √© o produtor, a vaca se alimenta dela e o humano se alimenta da vaca.",
        image: "grama_vaca_humano.png"
      },
      {
        animals: ["Flor", "Abelha", "Lagarto"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "A flor √© a produtora, a abelha consome o n√©ctar e o lagarto se alimenta da abelha.",
        image: "flor_abelha_lagarto.png"
      },
      {
        animals: ["Algodoeiro", "Pulg√£o", "Joaninha"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "O algodoeiro √© a planta produtora, o pulg√£o se alimenta de sua seiva e a joaninha come os pulg√µes.",
        image: "algodoeiro_pulgao_joaninha.png"
      },
      {
        animals: ["Bambu", "Panda", "Leopardo"],
        order: ["produtor", "consumidor1", "consumidor2"],
        explanation: "O bambu √© uma planta produtora, o panda gigante se alimenta do bambu e o leopardo √© o consumidor secund√°rio que pode predar o panda em seu habitat.",
        image: "bambu_panda_leopardo.png"
      }
    ];

    function startGame() {
      playerName = document.getElementById("player-name").value;
      if (!playerName) return alert("Digite seu nome!");
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-container").style.display = "block";
      document.getElementById("scoreboard-container").style.display = "block";
      document.getElementById("player-display").textContent = `Jogador: ${playerName}`;
      loadQuestion();
    }

    function loadQuestion() {
      currentAttempts = 0;
      const current = questions[currentIndex];
      document.getElementById("produtor").textContent = "Produtor";
      document.getElementById("consumidor1").textContent = "Consumidor Prim√°rio";
      document.getElementById("consumidor2").textContent = "Consumidor Secund√°rio";
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      document.getElementById("feedback").textContent = "";
      document.getElementById("verify-btn").disabled = false;
      
      const shuffled = [...current.animals].sort(() => Math.random() - 0.5);
      shuffled.forEach(animal => {
        const el = document.createElement("div");
        el.className = "animal";
        el.textContent = animal;
        el.onclick = () => {
          if(selectedElement) selectedElement.classList.remove('selected');
          selectedAnimalValue = animal;
          selectedElement = el;
          el.classList.add('selected');
        };
        optionsDiv.appendChild(el);
      });
    }

    function placeAnimal(slotId) {
      if (!selectedAnimalValue) return;
      document.getElementById(slotId).textContent = selectedAnimalValue;
      if(selectedElement) selectedElement.classList.remove('selected');
      selectedAnimalValue = null;
      selectedElement = null;
    }

    function checkAnswer() {
      currentAttempts++;
      const current = questions[currentIndex];
      const p = document.getElementById("produtor").textContent;
      const c1 = document.getElementById("consumidor1").textContent;
      const c2 = document.getElementById("consumidor2").textContent;
      
      const userFullResp = `P: ${p} | C1: ${c1} | C2: ${c2}`;
      const isCorrect = (p === current.animals[0] && c1 === current.animals[1] && c2 === current.animals[2]);

      allResponsesLog.push({
        rodada: currentIndex + 1,
        tentativa: currentAttempts,
        resposta: userFullResp,
        status: isCorrect ? "Correto" : "Errado"
      });

      const feedback = document.getElementById("feedback");
      if (isCorrect) {
        score += 10;
        attemptsPerQuestion.push(currentAttempts);
        feedback.textContent = "‚úÖ Correto! Muito bem!";
        feedback.style.color = "green";
        document.getElementById("score").textContent = `Pontos: ${score}`;
        document.getElementById("verify-btn").disabled = true;
        setTimeout(showExplanation, 1500);
      } else {
        lives--;
        updateLives();
        feedback.textContent = "‚ùå Tente novamente!";
        feedback.style.color = "red";
        if (lives <= 0) {
          alert("Fim de jogo! Vamos recome√ßar?");
          location.reload();
        }
      }
    }

    function updateLives() {
      document.getElementById("lives").textContent = `Vidas: ${'‚ù§Ô∏è'.repeat(lives)}`;
    }

    function showExplanation() {
      const current = questions[currentIndex];
      document.getElementById("game-container").style.display = "none";
      document.getElementById("explanation-container").style.display = "block";
      document.getElementById("explanation-text").textContent = current.explanation;
      document.getElementById("explanation-image").src = current.image;
    }

    function nextQuestion() {
      currentIndex++;
      if (currentIndex < questions.length) {
        document.getElementById("explanation-container").style.display = "none";
        document.getElementById("game-container").style.display = "block";
        loadQuestion();
      } else {
        showEndScreen();
      }
    }

    function showEndScreen() {
      document.getElementById("explanation-container").style.display = "none";
      document.getElementById("scoreboard-container").style.display = "none";
      document.getElementById("end-screen").style.display = "block";
      document.getElementById("final-player-name").textContent = playerName;

      const ctx = document.getElementById('attemptsChart').getContext('2d');
      new Chart(ctx, {
        type: 'line', 
        data: {
          labels: attemptsPerQuestion.map((_, i) => `Q${i+1}`),
          datasets: [{
            label: 'N√∫mero de Tentativas',
            data: attemptsPerQuestion,
            borderColor: '#1b4d3e',
            backgroundColor: 'rgba(27, 77, 62, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { 
            y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Tentativas' } }, 
            x: { title: { display: true, text: 'Quest√µes' } } 
          }
        }
      });
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFillColor(27, 77, 62);
      doc.rect(0, 0, 210, 20, 'F');
      doc.setTextColor(255, 255, 255);
      doc.text("BOLETIM DE DESEMPENHO - CADEIA ALIMENTAR", 15, 13);
      
      doc.setTextColor(0, 0, 0);
      doc.text(`Aluno: ${playerName}`, 15, 30);
      doc.text(`Pontos Totais: ${score}`, 15, 38);

      const rows = allResponsesLog.map(log => [
        log.rodada, 
        log.tentativa, 
        log.resposta, 
        log.status
      ]);
      
      doc.autoTable({
        startY: 45,
        head: [['Quest√£o', 'Tent.', 'Configura√ß√£o Enviada pelo Aluno', 'Resultado']],
        body: rows,
        headStyles: { 
          fillColor: [27, 77, 62], 
          textColor: [255, 255, 255], 
          fontStyle: 'bold' 
        },
        styles: { fontSize: 8 },
        columnStyles: { 2: { cellWidth: 100 } },
        theme: 'striped',
    
        didParseCell: function(data) {
          if (data.section === 'body' && data.column.index === 3) {
            if (data.cell.raw === 'Correto') {
              data.cell.styles.textColor = [0, 128, 0]; // Verde
              data.cell.styles.fontStyle = 'bold';
            } else if (data.cell.raw === 'Errado') {
              data.cell.styles.textColor = [200, 0, 0]; // Vermelho
              data.cell.styles.fontStyle = 'bold';
            }
          }
        }
      });

      doc.save(`boletim_detalhado_${playerName}.pdf`);
    }
  </script>
</body>
</html>